# WebSocket

**第一部分：WebSocket API**

## 二进制的类型
WebSocket的消息可以是文本或者二进制数据，可以设置接收二进制数据的格式：Blob、ArrayBuffer。
- Blob是不可变的文件对象，适合直接保存、传给img
- ArrayBuffer适合放在内存中进行操作

二进制数据可以用于传输文件、图片。普通消息用文本。

## 排队
发送消息前检查客户端缓冲的数据量。
```js
if(ws.bufferedAmount === 0) {
  ws.send(message);
}
```
消息按照客户端排队的顺序逐个发送，大量的消息甚至一个大消息，都会导致排在后面的消息延迟——队首阻塞！

## 子协议

通过使用子协议来沟通元数据，可以在JSON中定义一个字段，可以使用文本+二进制。

WebSocket提供了协商子协议的API——构造函数的第二个参数。浏览器选择一个协议，如果一个不选就会断开连接。

**第二部分：WebSocket协议**
## 协议
HTTP握手协商连接参数，二进制消息分帧进行文本和二进制数据消息传输。

## 二进制分帧层
将一个消息分成若干帧，传输以帧为单位进行，发送到目的地后组成起来，等接收到完整的消息时再通知接收方。

容易发生队首阻塞，因为消息的帧不能交错发送，要等一个消息的帧发送完了才会发送下一个消息的帧。

不支持多路复用，每个WebSocket连接需要一个TCP连接。

## HTTP升级协商

- HTTP握手
- Connection: Upgrade
- 跨域

## 性能

XHR轮询、SSE（EventSource协议）、WebSocket协议。

轮询有间隔时间，SSE客户端不能给服务端发消息，SSE和WebSocket都可以立即发消息。

## 实战

使用sockjs

使用stompjs

断线重连